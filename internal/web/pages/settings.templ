package pages

import (
	c "stockmarket/internal/web/components"
	"stockmarket/internal/web/components/icons"
)

// SettingsConfig holds the current configuration
type SettingsConfig struct {
	MarketDataProvider string
	HasMarketAPIKey    bool
	AIProvider         string
	AIModel            string
	HasAIAPIKey        bool
	RiskTolerance      string
	TradeFrequency     string
	PollingInterval    int
	TrackedSymbols     []string
	EmailAddress       string
	EmailEnabled       bool
	DiscordWebhook     string
	DiscordEnabled     bool
	SMSPhone           string
	SMSEnabled         bool
}

// SettingsPage renders the settings page
templ SettingsPage(config SettingsConfig) {
	@c.Layout(c.PageData{Title: "Settings", Page: "settings"}) {
		@c.PageHeader("Settings", "Configure your API keys, preferences, and notifications")
		<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
			@MarketDataSettings(config)
			@AIProviderSettings(config)
			@TradingStrategySettings(config)
			@WatchlistSettings(config.TrackedSymbols)
			@PollingSettings(config)
		</div>
		@NotificationSettings(config)
	}
}

// MarketDataSettings renders the market data provider settings card
templ MarketDataSettings(config SettingsConfig) {
	<div class="bg-bg-elevated rounded-xl border border-border p-6">
		<div class="flex items-center gap-3 mb-6">
			<div class="p-2 bg-info-bg rounded-lg">
				@icons.ChartBar("w-5 h-5 text-info")
			</div>
			<h2 class="text-lg font-semibold text-content-primary">Market Data Provider</h2>
		</div>
		<form hx-post="/api/config/market" hx-swap="none" hx-indicator="#market-spinner">
			<div class="space-y-4">
				@c.FormGroup() {
					@c.Label("market_data_provider", "Provider")
					@c.Select("market_data_provider", []c.SelectOption{
						{Value: "yahoo", Label: "Yahoo Finance (Free, No Key)", Selected: config.MarketDataProvider == "yahoo"},
						{Value: "alphavantage", Label: "Alpha Vantage", Selected: config.MarketDataProvider == "alphavantage"},
						{Value: "finnhub", Label: "Finnhub", Selected: config.MarketDataProvider == "finnhub"},
					})
				}
				@c.FormGroup() {
					@c.Label("market_data_api_key", "API Key")
					@c.InputWithConfigured("market_data_api_key", "market_data_api_key", "Leave empty to keep existing key", config.HasMarketAPIKey)
					@c.FormHint("Leave empty to keep existing key")
				}
				@c.SubmitButton("Save Market Settings", "market-spinner")
			</div>
		</form>
	</div>
}

// AIProviderSettings renders the AI provider settings card
templ AIProviderSettings(config SettingsConfig) {
	<div class="bg-bg-elevated rounded-xl border border-border p-6">
		<div class="flex items-center gap-3 mb-6">
			<div class="p-2 bg-accent/10 rounded-lg">
				@icons.Computer("w-5 h-5 text-accent")
			</div>
			<h2 class="text-lg font-semibold text-content-primary">AI Provider</h2>
		</div>
		<form hx-post="/api/config/ai" hx-swap="none" hx-indicator="#ai-spinner">
			<div class="space-y-4">
				@c.FormGroup() {
					@c.Label("ai_provider", "Provider")
					@c.Select("ai_provider", []c.SelectOption{
						{Value: "openai", Label: "OpenAI", Selected: config.AIProvider == "openai"},
						{Value: "claude", Label: "Claude (Anthropic)", Selected: config.AIProvider == "claude"},
						{Value: "gemini", Label: "Gemini (Google)", Selected: config.AIProvider == "gemini"},
					})
				}
				@c.FormGroup() {
					@c.Label("ai_model", "Model")
					<input
						type="text"
						name="ai_model"
						value={ config.AIModel }
						placeholder="e.g., gpt-4o, claude-3-sonnet"
						class="w-full px-4 py-2.5 bg-bg-primary border border-border rounded-lg text-content-primary placeholder:text-content-muted font-mono text-sm focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 transition-all duration-200"
					/>
				}
				@c.FormGroup() {
					@c.Label("ai_provider_api_key", "API Key")
					@c.InputWithConfigured("ai_provider_api_key", "ai_provider_api_key", "Leave empty to keep existing key", config.HasAIAPIKey)
					@c.FormHint("Leave empty to keep existing key")
				}
				@c.SubmitButton("Save AI Settings", "ai-spinner")
			</div>
		</form>
	</div>
}

// TradingStrategySettings renders the trading strategy settings card
templ TradingStrategySettings(config SettingsConfig) {
	<div class="bg-bg-elevated rounded-xl border border-border p-6">
		<div class="flex items-center gap-3 mb-6">
			<div class="p-2 bg-positive-bg rounded-lg">
				@icons.TrendingUp("w-5 h-5 text-positive")
			</div>
			<h2 class="text-lg font-semibold text-content-primary">Trading Strategy</h2>
		</div>
		<form hx-post="/api/config/strategy" hx-swap="none" hx-indicator="#strategy-spinner">
			<div class="space-y-4">
				@c.FormGroup() {
					@c.Label("risk_tolerance", "Risk Tolerance")
					@c.Select("risk_tolerance", []c.SelectOption{
						{Value: "conservative", Label: "Conservative - Capital preservation", Selected: config.RiskTolerance == "conservative"},
						{Value: "moderate", Label: "Moderate - Balanced growth/risk", Selected: config.RiskTolerance == "moderate"},
						{Value: "aggressive", Label: "Aggressive - Maximum growth", Selected: config.RiskTolerance == "aggressive"},
					})
				}
				@c.FormGroup() {
					@c.Label("trade_frequency", "Trade Frequency")
					@c.Select("trade_frequency", []c.SelectOption{
						{Value: "daily", Label: "Daily Trading", Selected: config.TradeFrequency == "daily"},
						{Value: "weekly", Label: "Weekly Trading", Selected: config.TradeFrequency == "weekly"},
						{Value: "swing", Label: "Swing Trading (2-6 weeks)", Selected: config.TradeFrequency == "swing"},
					})
				}
				@c.SubmitButton("Save Strategy", "strategy-spinner")
			</div>
		</form>
	</div>
}

// WatchlistSettings renders the watchlist management card
templ WatchlistSettings(symbols []string) {
	<div class="bg-bg-elevated rounded-xl border border-border p-6">
		<div class="flex items-center gap-3 mb-6">
			<div class="p-2 bg-warning-bg rounded-lg">
				@icons.Clipboard("w-5 h-5 text-warning")
			</div>
			<h2 class="text-lg font-semibold text-content-primary">Watchlist</h2>
		</div>
		<!-- Add Symbol Form -->
		<form hx-post="/api/config/watchlist" hx-target="#watchlist-items" hx-swap="innerHTML" hx-on::after-request="this.reset()" hx-indicator="#watchlist-spinner" class="mb-4">
			<div class="flex gap-2">
				<input
					type="text"
					name="symbol"
					placeholder="Enter symbol (e.g., AAPL)"
					class="flex-1 px-4 py-2.5 bg-bg-primary border border-border rounded-lg text-content-primary placeholder:text-content-muted font-mono uppercase focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20 transition-all duration-200"
					required
				/>
				<button
					type="submit"
					class="px-4 py-2.5 bg-accent hover:bg-accent-hover text-white font-medium rounded-lg transition-colors duration-200 flex items-center gap-2"
				>
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
					</svg>
					<span class="hidden sm:inline">Add</span>
				</button>
			</div>
		</form>
		<!-- Tracked Symbols List -->
		<div class="space-y-4">
			<p class="text-sm text-content-muted">Tracked Symbols</p>
			<div id="watchlist-items" class="space-y-2">
				if len(symbols) == 0 {
					<div class="text-center py-6">
						<p class="text-sm text-content-muted">No symbols in watchlist</p>
					</div>
				} else {
					for _, symbol := range symbols {
						@WatchlistSettingsItem(symbol)
					}
				}
			</div>
		</div>
		<div id="watchlist-spinner" class="htmx-indicator flex justify-center py-2">
			<div class="animate-spin rounded-full h-5 w-5 border-2 border-accent border-t-transparent"></div>
		</div>
	</div>
}

// WatchlistSettingsItemsPartial renders just the watchlist items for HTMX updates
templ WatchlistSettingsItemsPartial(symbols []string) {
	if len(symbols) == 0 {
		<div class="text-center py-6">
			<p class="text-sm text-content-muted">No symbols in watchlist</p>
		</div>
	} else {
		for _, symbol := range symbols {
			@WatchlistSettingsItem(symbol)
		}
	}
}

// WatchlistSettingsItem renders a single watchlist item with delete button
templ WatchlistSettingsItem(symbol string) {
	<div class="flex items-center justify-between p-3 bg-bg-tertiary/50 rounded-lg border border-border group hover:border-accent/30 transition-all duration-200">
		<span class="font-mono font-semibold text-content-primary">{ symbol }</span>
		<button
			hx-delete={ "/api/config/watchlist/" + symbol }
			hx-target="#watchlist-items"
			hx-swap="innerHTML"
			hx-confirm={ "Remove " + symbol + " from watchlist?" }
			class="p-1.5 text-content-muted hover:text-negative hover:bg-negative-bg/50 rounded-lg opacity-0 group-hover:opacity-100 transition-all duration-200"
			aria-label={ "Remove " + symbol }
		>
			<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
			</svg>
		</button>
	</div>
}

// PollingSettings renders the polling configuration card
templ PollingSettings(config SettingsConfig) {
	<div class="bg-bg-elevated rounded-xl border border-border p-6">
		<div class="flex items-center gap-3 mb-6">
			<div class="p-2 bg-info-bg rounded-lg">
				@icons.Refresh("w-5 h-5 text-info")
			</div>
			<h2 class="text-lg font-semibold text-content-primary">Polling Configuration</h2>
		</div>
		<form hx-post="/api/config/polling" hx-swap="none" hx-indicator="#polling-spinner">
			<div class="space-y-4">
				@c.FormGroup() {
					@c.Label("polling_interval", "Data Refresh Interval")
					@c.Select("polling_interval", []c.SelectOption{
						{Value: "30", Label: "30 seconds", Selected: config.PollingInterval == 30},
						{Value: "60", Label: "1 minute", Selected: config.PollingInterval == 60},
						{Value: "300", Label: "5 minutes", Selected: config.PollingInterval == 300},
						{Value: "900", Label: "15 minutes", Selected: config.PollingInterval == 900},
						{Value: "1800", Label: "30 minutes", Selected: config.PollingInterval == 1800},
						{Value: "3600", Label: "1 hour", Selected: config.PollingInterval == 3600},
					})
					@c.FormHint("How often to fetch fresh market data")
				}
				@c.SubmitButton("Save Polling Settings", "polling-spinner")
			</div>
		</form>
	</div>
}

// NotificationSettings renders the notification settings section
templ NotificationSettings(config SettingsConfig) {
	<div class="mt-6 bg-bg-elevated rounded-xl border border-border p-6">
		<div class="flex items-center gap-3 mb-6">
			<div class="p-2 bg-negative-bg rounded-lg">
				@icons.Bell("w-5 h-5 text-negative")
			</div>
			<h2 class="text-lg font-semibold text-content-primary">Notifications</h2>
		</div>
		<form hx-post="/api/config/notifications" hx-swap="none" hx-indicator="#notif-spinner">
			<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
				<!-- Email -->
				<div class="space-y-4">
					<h3 class="text-sm font-semibold text-content-primary uppercase tracking-wider">Email</h3>
					<div class="space-y-3">
						@c.InputEmail("email_address", "email_address", "your@email.com", config.EmailAddress)
						@c.Checkbox("email_enabled", "Enable email notifications", config.EmailEnabled)
					</div>
				</div>
				<!-- Discord -->
				<div class="space-y-4">
					<h3 class="text-sm font-semibold text-content-primary uppercase tracking-wider">Discord</h3>
					<div class="space-y-3">
						@c.Input("discord_webhook", "discord_webhook", "Webhook URL", config.DiscordWebhook, false)
						@c.Checkbox("discord_enabled", "Enable Discord notifications", config.DiscordEnabled)
					</div>
				</div>
				<!-- SMS -->
				<div class="space-y-4">
					<h3 class="text-sm font-semibold text-content-primary uppercase tracking-wider">SMS (Twilio)</h3>
					<div class="space-y-3">
						@c.InputTel("sms_phone", "sms_phone", "+1234567890", config.SMSPhone)
						@c.Checkbox("sms_enabled", "Enable SMS notifications", config.SMSEnabled)
					</div>
				</div>
			</div>
			<div class="mt-6 pt-6 border-t border-border">
				@c.SubmitButton("Save Notification Settings", "notif-spinner")
			</div>
		</form>
	</div>
}
